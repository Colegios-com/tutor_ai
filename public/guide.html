<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aldous | Tu profesor virtual por WhatsApp</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üñçÔ∏è</text></svg>">
    <meta property="og:title" content="Aldous | Tu profesor virtual por WhatsApp" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://colegios-media.s3.us-east-1.amazonaws.com/thumbnails/logo.png" />
    <style>
        /* Font Faces */
        @font-face {
            font-family: 'IntroScript';
            src: url('fonts/IntroScript/IntroScript-Trial-Black.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Mont';
            src: url('fonts/Mont/Mont-Regular.woff2') format('woff2'),
                 url('fonts/Mont/Mont-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Mont';
            src: url('fonts/Mont/Mont-Bold.woff2') format('woff2'),
                 url('fonts/Mont/Mont-Bold.woff') format('woff');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        /* Root Variables & Base Styles */
        :root {
            --primary: #25D366;
            --dark: #075E54;
            --light: #DCF8C6;
            --white: #ffffff;
            --accent: #ff4444;
            --error: #ff4444;
            --desktop-padding: max(20px, min(8vw, 50px));
            --mobile-padding: 20px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Mont', sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
            width: 100%;
            background-color: var(--light);
        }
        /* Guide Section Styles */
        .guide-section {
            padding: var(--desktop-padding);
            background: linear-gradient(to bottom, var(--white), var(--light));
            margin-bottom: 50px;
        }
        .section-title {
            font-size: clamp(36px, 8vw, 80px);
            font-weight: 900;
            color: var(--dark);
            text-align: center;
            margin-bottom: 40px;
            line-height: 1.2;
            padding: 0 20px;
        }
        .section-description {
            font-size: clamp(16px, 2.5vw, 20px);
            color: var(--dark);
            opacity: 0.8;
            text-align: center;
            max-width: min(600px, 90%);
            margin: 0 auto 60px;
            padding: 0 20px;
        }
        .guide-container {
            max-width: 800px;
            margin: 0 auto;
        }
        /* Node Styles */
        .node {
            margin-bottom: 40px;
        }
        .node-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }
        .node-type {
            background: var(--primary);
            color: var(--white);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
        }
        .node-title {
            font-size: 28px;
            color: var(--dark);
            margin-bottom: 20px;
        }
        .parent-node-title {
            font-size: 36px;
            color: var(--dark);
            margin-bottom: 20px;
        }
        .criteria-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }
        .milestone {
            margin-bottom: 40px;
        }
        .milestone h4 {
            font-size: 24px;
            color: var(--dark);
            margin-bottom: 10px;
        }
        .milestone p {
            color: var(--dark);
            opacity: 0.8;
            margin-bottom: 20px;
        }
        .criteria-list {
            list-style-type: none;
            padding-left: 0;
        }
        .criteria-list li {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .criteria-list input {
            margin-right: 10px;
        }
        .lists-container {
            margin-bottom: 40px;
        }
        .lists-container h4 {
            font-size: 24px;
            color: var(--dark);
            margin-bottom: 10px;
        }
        .lists-container ul {
            list-style-type: none;
            padding-left: 0;
        }
        .lists-container ul li {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .lists-container ul input {
            margin-right: 10px;
        }
        .branches {}
    </style>
</head>
<body>
    <section class="guide-section">
        <h2 class="section-title">Gu√≠a de Estudio</h2>
        <p class="section-description">¬°Domina los conceptos paso a paso y marca tu progreso!</p>
        <div class="guide-container">
            <div id="guide-root"></div>
        </div>
    </section>
    <script>
        // guide.js
        const API_BASE_URL = 'https://tutor-api.colegios.com';

        // URL and Auth Handling
        function getAuthDataFromUrl() {
            const pathSegments = window.location.pathname.split('/');
            const guideIndex = pathSegments.indexOf('guide');
            if (guideIndex === -1) return null;
            return {
                guideId: pathSegments[guideIndex + 1],
                authToken: pathSegments[guideIndex + 2]
            };
        }

        // Data Fetching
        async function fetchData(endpoint, options) {
            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching data from ${endpoint}:`, error);
                return null;
            }
        }

        async function getGuideData(guideId, authToken) {
            const options = {
                method: 'GET',
                headers: {
                    'Authorization': authToken,
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            };
            return await fetchData(`get_content/?content_type=guides&content_id=${guideId}`, options);
        }

        async function updateGuideData(guideId, authToken, data) {
            const options = {
                method: 'POST',
                headers: {
                    'Authorization': authToken,
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify(data)
            };
            return await fetchData(`update_content/?content_type=guides&content_id=${guideId}`, options);
        }

        // State Management
        window.guideData = null;

        // Progress Management
        function getCriterionKey(nodeId, criterionIdx, guideId) {
            return `guide-${guideId}-criterion-${nodeId}-${criterionIdx}`;
        }

        // UI Generation
        function generateNodeHTML(node, path = '', guideId, level = 1) {
            const nodeId = path || 'root';
            const title = node.title || 'No Title';
            const type = node.type || 'No Type';
            const description = node.description || 'No Description';
            const milestone = node.milestone || { description: 'No Milestone Description', criteria: [], measurement: 'No Measurement' };
            const prerequisites = node.prerequisites || [];
            const key_questions = node.key_questions || [];
            const branches = node.branches || [];
            const nodeTitleClass = level === 1 ? 'parent-node-title' : 'node-title';
            const nodeOrdinal = level === 1 ? '' : getOrdinal(path.split('-').length - 1);
            return `
                <div class="node" data-node-id="${nodeId}">
                    <div class="node-header">
                        <h3 class="${nodeTitleClass}">${nodeOrdinal} ${title}</h3>
                        <span class="node-type">${type}</span>
                    </div>
                    <p class="node-description">${description}</p>
                    <div class="milestone">
                        <h4>Milestone</h4>
                        <p>${milestone.description}</p>
                        <ul class="criteria-list">
                            ${milestone.criteria.map((criterion, idx) => {
                                const criterionKey = getCriterionKey(nodeId, idx, guideId);
                                return `
                                    <li>
                                        <input type="checkbox" class="criteria-checkbox" id="${criterionKey}" onchange="updateCriterion('${nodeId}', ${idx}, '${guideId}')">
                                        <span>${String.fromCharCode(65 + idx)}. ${criterion}</span>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                        <p><strong>Measurement:</strong> ${milestone.measurement}</p>
                    </div>
                    <div class="lists-container">
                        <div class="list-section">
                            <h4>Prerequisites</h4>
                            <ul>
                                ${prerequisites.map((prereq, idx) => `
                                    <li>
                                        <input type="checkbox" class="criteria-checkbox" id="${getProgressKey(nodeId, guideId)}-${idx}" onchange="updateProgress('${nodeId}', '${guideId}')">
                                        <span>${prereq}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="list-section">
                            <h4>Key Questions</h4>
                            <ul>
                                ${key_questions.map((resource, idx) => `
                                    <li>
                                        <input type="checkbox" class="criteria-checkbox" id="${getProgressKey(nodeId, guideId)}-resource-${idx}" onchange="updateProgress('${nodeId}', '${guideId}')">
                                        <span>${resource}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    ${branches.map((branch, idx) => generateNodeHTML(branch, `${nodeId}-${idx + 1}`, guideId, level + 1)).join('')}
                </div>
            `;
        }

        function getOrdinal(level) {
            const ordinals = ['I.', 'II.', 'III.', 'IV.', 'V.', 'VI.', 'VII.', 'VIII.', 'IX.', 'X.', 'XI.', 'XII.', 'XIII.', 'XIV.', 'XV.', 'XVI.', 'XVII.', 'XVIII.', 'XIX.', 'XX.', 'XXI.', 'XXII.', 'XXIII.', 'XXIV.', 'XXV.', 'XXVI.', 'XXVII.', 'XXVIII.', 'XXIX.', 'XXX.'];
            return ordinals[level - 1] || level;
        }

        // Progress Tracking
        async function updateProgress(nodeId, guideId) {
            updateParentProgress(nodeId, guideId);
            await saveProgress(guideId);
        }

        async function updateCriterion(nodeId, criterionIdx, guideId) {
            updateParentProgress(nodeId, guideId);
            await saveProgress(guideId);
        }

        function updateParentProgress(nodeId, guideId) {
            if (nodeId === 'root') return;
            const parentId = nodeId.split('-').slice(0, -1).join('-');
            if (!parentId) return;
            const parentNode = document.querySelector(`[data-node-id="${parentId}"]`);
            if (!parentNode) return;
            const childNodes = parentNode.querySelectorAll('.criteria-checkbox');
            const allChecked = Array.from(childNodes).every(checkbox => checkbox.checked);
            const parentProgressKey = getProgressKey(parentId, guideId);
            const parentCheckbox = document.getElementById(parentProgressKey);
            if (parentCheckbox) {
                parentCheckbox.checked = allChecked;
            }
            updateParentProgress(parentId, guideId);
        }

        async function saveProgress(guideId) {
            const authData = getAuthDataFromUrl();
            if (!authData) return;
            try {
                const progressData = {
                    ...window.guideData,
                    progress: collectProgressData(guideId)
                };
                await updateGuideData(authData.guideId, authData.authToken, progressData);
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        function collectProgressData(guideId) {
            const progressData = {};
            document.querySelectorAll('.node').forEach(node => {
                const nodeId = node.dataset.nodeId;
                progressData[nodeId] = {
                    completed: document.getElementById(getProgressKey(nodeId, guideId)) ? document.getElementById(getProgressKey(nodeId, guideId)).checked : false,
                    criteria: Array.from(node.querySelectorAll('.criteria-checkbox')).map((checkbox, idx) => checkbox.checked)
                };
            });
            return progressData;
        }

        function getProgressKey(nodeId, guideId) {
            return `guide-${guideId}-progress-${nodeId}`;
        }

        // Initialization
        async function initializeGuide() {
            const authData = getAuthDataFromUrl();
            if (!authData) {
                console.error('Invalid guide URL');
                return;
            }
            window.guideData = await getGuideData(authData.guideId, authData.authToken);
            if (window.guideData) {
                const container = document.getElementById('guide-root');
                container.innerHTML = generateNodeHTML(window.guideData, '', authData.guideId);
            } else {
                console.error('Failed to load guide data');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', initializeGuide);
    </script>
</body>
</html>